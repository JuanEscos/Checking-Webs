name: MonitorizacionWebs

on:
  schedule:
    - cron: '5 4 * * *'   # Cada día a las 04:05 UTC
  workflow_dispatch:        # Permitir ejecución manual

jobs:
  check-sites:
    runs-on: ubuntu-22.04

    env:
      TZ: Europe/Madrid
      URLS_FILE: monitoring/urls_to_check.txt

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run health check
        id: healthcheck
        run: |
          python .github/scripts/check_urls.py

      # ✅ CORREO DE TODO CORRECTO (SOLO EN EJECUCIONES MANUALES)
      - name: Send OK email on success (manual runs only)
        if: ${{ success() && github.event_name == 'workflow_dispatch' }}
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}   # 465
          secure: true
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "OK: Monitorización de webs agilitydivertidog.com correcta"
          to: "jescos@agilitydivertidog.com"
          from: "Monitor GitHub <${{ secrets.SMTP_USER }}>"
          secure: true
          body: |
            La monitorización de las URLs configuradas ha finalizado correctamente.

            No se ha detectado ningún error en las webs monitorizadas.
            (Este correo solo se envía en ejecuciones manuales de prueba.)

      # ❌ CORREO DE ERROR (DIARIO + MANUAL)
      - name: Send alert email if failure
        if: failure()
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}   # 465
          secure: true
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "ALERTA: Alguna web de agilitydivertidog.com ha fallado"
          to: "jescos@agilitydivertidog.com"
          from: "Monitor GitHub <${{ secrets.SMTP_USER }}>"
          secure: true
          body: |
            Se ha detectado un error en la monitorización de alguna de las URLs configuradas.

            Revisa el log del workflow en GitHub Actions para ver el detalle.
          attachments: |
            monitoring_result.txt
